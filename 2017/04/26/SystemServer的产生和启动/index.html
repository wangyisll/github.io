<!DOCTYPE html><html lang="null"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>SystemServer的产生和启动 | 喵了个呜的小宇宙</title><link rel="stylesheet" type="text/css" href="//fonts.css.network/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">SystemServer的产生和启动</h1><a id="logo" href="/.">喵了个呜的小宇宙</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> Home</i></a><a href="/archives/"><i class="fa fa-archive"> Archive</i></a><a href="/about/"><i class="fa fa-user"> About</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Search"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">SystemServer的产生和启动</h1><div class="post-meta"><span class="date">Apr 26, 2017</span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i> Hits</i></i></span><a href="/2017/04/26/SystemServer的产生和启动/#comments" class="comment-count">Guestbook</a></div><div class="post-content"><h1 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h1><p>基于Android7.1源码。</p>
<p>结合一些文章想看一下Android的SystemServer的产生和启动，发现7.1的代码和文章上的不太一样，只玩的源码我也没看过，不知道什么时候开始变得。就做一个记录。<br><a id="more"></a><br>大致流程就是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">st=&gt;start: Start</div><div class="line">e=&gt;end: End</div><div class="line">op1=&gt;operation: 系统的第一个用户进程Init进程启动</div><div class="line">op2=&gt;operation: 解析init.rc文件</div><div class="line">op3=&gt;operation: 从init进程中fork出zygote进程，也就是app_main.cpp文件</div><div class="line">op4=&gt;operation: zygote进程调用AppRuntime的start方法启动ZygoteInit，进入java</div><div class="line">op5=&gt;operation: ZygoteInit中从zygote进程fork一个system_server进程</div><div class="line">op6=&gt;operation: ZygoteInit调用RuntimeInit.zygoteInit方法，找到SystemServer类和他的main方法</div><div class="line">op7=&gt;operation: 由ZygoteInit执行SystemServer的main方法</div><div class="line">st-&gt;op1-&gt;op2-&gt;op3-&gt;op4-&gt;op5-&gt;op6-&gt;op7-&gt;e</div></pre></td></tr></table></figure>
<h1 id="init进程"><a href="#init进程" class="headerlink" title="init进程"></a>init进程</h1><p>init是Android系统中用户级的第一个进程。通过<code>ps</code>命令可以看到，进程ID是1.</p>
<p><img src="http://privateimage.oss-cn-hongkong.aliyuncs.com/Android/sys1.png" alt="">。</p>
<p>既然整个用户系统都是从init开始的，那么SystemService肯定也是从这里创建了。</p>
<p>init进程的入口是main()方法</p>
<p><code>/system/core/init/init.cpp：</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</div><div class="line">    parser.ParseConfig(<span class="string">"/init.rc"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>要解析一个<code>init.rc</code>文件</p>
<p><code>/system/core/rootdir/init.rc:</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">import /init.$&#123;ro.zygote&#125;.rc</div></pre></td></tr></table></figure>
<p>在这个文件夹下还有这些文件：</p>
<p><img src="http://privateimage.oss-cn-hongkong.aliyuncs.com/Android/sys2.png" alt=""></p>
<p>以<code>init.zygote64.rc</code>为例</p>
<p><code>/system/core/rootdir/init.zygote64.rc</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server</div><div class="line">    class main</div><div class="line">    socket zygote stream 660 root system</div><div class="line">    onrestart write /sys/android_power/request_state wake</div><div class="line">    onrestart write /sys/power/state on</div><div class="line">    onrestart restart audioserver</div><div class="line">    onrestart restart cameraserver</div><div class="line">    onrestart restart media</div><div class="line">    onrestart restart netd</div><div class="line">    writepid /dev/cpuset/foreground/tasks</div></pre></td></tr></table></figure>
<p>通过解析这个文件，会从init进程中fork出zygote进程。</p>
<h1 id="zygote进程"><a href="#zygote进程" class="headerlink" title="zygote进程"></a>zygote进程</h1><p>zygote对应的源文件是<code>app_main.cpp</code>,这个进程把自己的名字重命名为zygote。</p>
<p><code>/frameworks/base/cmds/app_process/app_main.cpp：</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">static const char ZYGOTE_NICE_NAME[] = "zygote64";</div><div class="line">int main(int argc, char* const argv[])&#123;</div><div class="line">    AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));</div><div class="line">    while (i &lt; argc) &#123;</div><div class="line">        const char* arg = argv[i++];</div><div class="line">        if (strcmp(arg, "--zygote") == 0) &#123;</div><div class="line">            zygote = true;</div><div class="line">            niceName = ZYGOTE_NICE_NAME;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    //重命名进程名字</div><div class="line">    if (!niceName.isEmpty()) &#123;</div><div class="line">        runtime.setArgv0(niceName.string());</div><div class="line">        set_process_name(niceName.string());</div><div class="line">    &#125;</div><div class="line">    if (zygote) &#123;</div><div class="line">        runtime.start("com.android.internal.os.ZygoteInit", args, zygote);</div><div class="line">    &#125; else if (className) &#123;</div><div class="line">        runtime.start("com.android.internal.os.RuntimeInit", args, zygote);</div><div class="line">    &#125; else &#123;</div><div class="line">        fprintf(stderr, "Error: no class name or --zygote supplied.\n");</div><div class="line">        app_usage();</div><div class="line">        LOG_ALWAYS_FATAL("app_process: no class name or --zygote supplied.");</div><div class="line">        return 10;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>看到最后又一句<code>runtime.start(&quot;com.android.internal.os.ZygoteInit&quot;, args, zygote);</code>，把事情交给runtime去做。runtime是AppRuntime，AppRuntime是继承AndroidRuntime的：</p>
<p><code>/frameworks/base/cmds/app_process/app_main.cpp：</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppRuntime</span> :</span> <span class="keyword">public</span> AndroidRuntime&#123;</div><div class="line">    <span class="keyword">public</span>:AppRuntime(<span class="keyword">char</span>* argBlockStart, <span class="keyword">const</span> <span class="keyword">size_t</span> argBlockLength)</div><div class="line">        : AndroidRuntime(argBlockStart, argBlockLength)</div><div class="line">        , mClass(<span class="literal">NULL</span>)&#123;&#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setClassNameAndArgs</span><span class="params">(<span class="keyword">const</span> String8&amp; className, <span class="keyword">int</span> argc, <span class="keyword">char</span> * <span class="keyword">const</span> *argv)</span> </span>&#123;</div><div class="line">        ......</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onVmCreated</span><span class="params">(JNIEnv* env)</span></span>&#123;</div><div class="line">        ......</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onStarted</span><span class="params">()</span></span>&#123;</div><div class="line">        ......</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onZygoteInit</span><span class="params">()</span></span>&#123;</div><div class="line">        ......</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">onExit</span><span class="params">(<span class="keyword">int</span> code)</span></span>&#123;</div><div class="line">        ......</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AppRuntime并没有start方法，因此start方法是AndroidRuntime的：</p>
<p><code>/frameworks/base/core/jni/AndroidRuntime.cpp</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> AndroidRuntime::start(<span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="keyword">bool</span> zygote)</div><div class="line">&#123;</div><div class="line">    <span class="comment">//设置ANDROID_ROOT环境变量</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* rootDir = getenv(<span class="string">"ANDROID_ROOT"</span>);</div><div class="line">    <span class="keyword">if</span> (rootDir == <span class="literal">NULL</span>) &#123;</div><div class="line">        rootDir = <span class="string">"/system"</span>;</div><div class="line">        <span class="keyword">if</span> (!hasDir(<span class="string">"/system"</span>)) &#123;</div><div class="line">            LOG_FATAL(<span class="string">"No root directory specified, and /android does not exist."</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        setenv(<span class="string">"ANDROID_ROOT"</span>, rootDir, <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//启动虚拟机</span></div><div class="line">    <span class="keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote) != <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    onVmCreated(env);</div><div class="line"></div><div class="line">    <span class="comment">//注册Android的JNI函数</span></div><div class="line">    <span class="keyword">if</span> (startReg(env) &lt; <span class="number">0</span>) &#123;</div><div class="line">        ALOGE(<span class="string">"Unable to register all android natives\n"</span>);</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//用数组保存类名和参数</span></div><div class="line">    stringClass = env-&gt;FindClass(<span class="string">"java/lang/String"</span>);</div><div class="line">    strArray = env-&gt;NewObjectArray(options.size() + <span class="number">1</span>, stringClass, <span class="literal">NULL</span>);</div><div class="line">    classNameStr = env-&gt;NewStringUTF(className);</div><div class="line">    env-&gt;SetObjectArrayElement(strArray, <span class="number">0</span>, classNameStr);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; options.size(); ++i) &#123;</div><div class="line">        jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).<span class="built_in">string</span>());</div><div class="line">        assert(optionsStr != <span class="literal">NULL</span>);</div><div class="line">        env-&gt;SetObjectArrayElement(strArray, i + <span class="number">1</span>, optionsStr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//找到这个类，并执行这个类的main方法，前面调用时传入的是`com.android.internal.os.ZygoteInit`</span></div><div class="line">    <span class="keyword">char</span>* slashClassName = toSlashClassName(className);</div><div class="line">    jclass startClass = env-&gt;FindClass(slashClassName);</div><div class="line">    <span class="keyword">if</span> (startClass == <span class="literal">NULL</span>) &#123;</div><div class="line">        ALOGE(<span class="string">"JavaVM unable to locate class '%s'\n"</span>, slashClassName);</div><div class="line">        <span class="comment">/* keep going */</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//找到main方法</span></div><div class="line">        jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="string">"main"</span>,</div><div class="line">            <span class="string">"([Ljava/lang/String;)V"</span>);</div><div class="line">        <span class="keyword">if</span> (startMeth == <span class="literal">NULL</span>) &#123;</div><div class="line">            ALOGE(<span class="string">"JavaVM unable to find main() in '%s'\n"</span>, className);</div><div class="line">            <span class="comment">/* keep going */</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//通过JNI执行main方法,com.android.internal.os.ZygoteInit是一个java类</span></div><div class="line">            env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//zygote退出</span></div><div class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DetachCurrentThread() != JNI_OK)</div><div class="line">        ALOGW(<span class="string">"Warning: unable to detach main thread\n"</span>);</div><div class="line">    <span class="keyword">if</span> (mJavaVM-&gt;DestroyJavaVM() != <span class="number">0</span>)</div><div class="line">        ALOGW(<span class="string">"Warning: VM did not shut down cleanly\n"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个start方法启动AndroidRuntime，先启动虚拟机，然后注册JNI函数，最后通过传进来的第一个参数找到相应的类，并执行他的main()方法。</p>
<p>这时，从native进入java层了。</p>
<h1 id="进入Java代码-ZygoteInit-java"><a href="#进入Java代码-ZygoteInit-java" class="headerlink" title="进入Java代码 ZygoteInit.java"></a>进入Java代码 ZygoteInit.java</h1><p>下面就是ZygoteInit的main方法:</p>
<p><code>/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java:</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            RuntimeInit.enableDdms();</div><div class="line">            <span class="comment">// 开始 zygote 初始化.</span></div><div class="line">            SamplingProfilerIntegration.start();</div><div class="line">            <span class="keyword">boolean</span> startSystemServer = <span class="keyword">false</span>;</div><div class="line">            String socketName = <span class="string">"zygote"</span>;</div><div class="line">            String abiList = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; argv.length; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (<span class="string">"start-system-server"</span>.equals(argv[i])) &#123;</div><div class="line">                    startSystemServer = <span class="keyword">true</span>;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;</div><div class="line">                    abiList = argv[i].substring(ABI_LIST_ARG.length());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//注册一个服务端的socket供zygote使用</span></div><div class="line">            registerZygoteSocket(socketName);</div><div class="line">            <span class="comment">//预加载，包括类，资源，等等</span></div><div class="line">            preload();</div><div class="line">            <span class="comment">// 结束zygote 初始化.</span></div><div class="line">            SamplingProfilerIntegration.writeZygoteSnapshot();</div><div class="line">            <span class="comment">// 进行一次垃圾回收</span></div><div class="line">            gcAndFinalize();</div><div class="line">            <span class="keyword">if</span> (startSystemServer) &#123;</div><div class="line">                <span class="comment">//启动system_server进程</span></div><div class="line">                startSystemServer(abiList, socketName);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</div><div class="line">            ......</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">preload</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"begin preload"</span>);</div><div class="line">        beginIcuCachePinning();</div><div class="line">        preloadClasses();</div><div class="line">        preloadResources();</div><div class="line">        preloadOpenGL();</div><div class="line">        preloadSharedLibraries();</div><div class="line">        preloadTextResources();</div><div class="line">        <span class="comment">// Ask the WebViewFactory to do any initialization that must run in the zygote process,</span></div><div class="line">        <span class="comment">// for memory sharing purposes.</span></div><div class="line">        WebViewFactory.prepareWebViewInZygote();</div><div class="line">        endIcuCachePinning();</div><div class="line">        warmUpJcaProviders();</div><div class="line">        Log.d(TAG, <span class="string">"end preload"</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ZygoteInit的main方法中调用<code>startSystemServer(abiList, socketName)</code>算是启动了system_server进程。</p>
<h1 id="system-server进程的产生"><a href="#system-server进程的产生" class="headerlink" title="system_server进程的产生"></a>system_server进程的产生</h1><p>system_server是Android系统Service运行的进程,这个进程死了后，会导致zygote进程重新启动.</p>
<p>startSystemServer也是ZygoteInit的方法：</p>
<p><code>/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java:</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startSystemServer</span><span class="params">(String abiList, String socketName)</span></span></div><div class="line">            <span class="keyword">throws</span> MethodAndArgsCaller, RuntimeException &#123;</div><div class="line">        <span class="comment">/* 硬编码命令行启动系统服务器 */</span></div><div class="line">        String args[] = &#123;</div><div class="line">            <span class="string">"--setuid=1000"</span>,</div><div class="line">            <span class="string">"--setgid=1000"</span>,</div><div class="line">            <span class="string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007,3009,3010"</span>,</div><div class="line">            <span class="string">"--capabilities="</span> + capabilities + <span class="string">","</span> + capabilities,</div><div class="line">            <span class="string">"--nice-name=system_server"</span>, <span class="comment">//进程名system_server</span></div><div class="line">            <span class="string">"--runtime-args"</span>,</div><div class="line">            <span class="string">"com.android.server.SystemServer"</span>,<span class="comment">//启动类 SystemServer</span></div><div class="line">        &#125;;</div><div class="line">        ZygoteConnection.Arguments parsedArgs = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//把上面的命令转为Arguments对象</span></div><div class="line">            parsedArgs = <span class="keyword">new</span> ZygoteConnection.Arguments(args);</div><div class="line">            <span class="comment">/* 从Zygote进程中fork一个system server 子进程 */</span></div><div class="line">            pid = Zygote.forkSystemServer(</div><div class="line">                    parsedArgs.uid, parsedArgs.gid,</div><div class="line">                    parsedArgs.gids,</div><div class="line">                    parsedArgs.debugFlags,</div><div class="line">                    <span class="keyword">null</span>,</div><div class="line">                    parsedArgs.permittedCapabilities,</div><div class="line">                    parsedArgs.effectiveCapabilities);</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (hasSecondZygote(abiList)) &#123;</div><div class="line">                waitForSecondaryZygote(socketName);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            handleSystemServerProcess(parsedArgs);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>从Zygote进程中fork一个system server 子进程，那么Zygote.forkSystemServer做了什么，怎么启动SystemServer的呢？</p>
<p><code>/frameworks/base/core/java/com/android/internal/os/Zygote.java:</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">forkSystemServer</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids, <span class="keyword">int</span> debugFlags,</span></span></div><div class="line">            <span class="keyword">int</span>[][] rlimits, <span class="keyword">long</span> permittedCapabilities, <span class="keyword">long</span> effectiveCapabilities) &#123;</div><div class="line">        VM_HOOKS.preFork();</div><div class="line">        <span class="keyword">int</span> pid = nativeForkSystemServer(</div><div class="line">                uid, gid, gids, debugFlags, rlimits, permittedCapabilities, effectiveCapabilities);</div><div class="line">        <span class="comment">// Enable tracing as soon as we enter the system_server.</span></div><div class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</div><div class="line">            Trace.setTracingEnabled(<span class="keyword">true</span>);</div><div class="line">        &#125;</div><div class="line">        VM_HOOKS.postForkCommon();</div><div class="line">        <span class="keyword">return</span> pid;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">native</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">nativeForkSystemServer</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> gid, <span class="keyword">int</span>[] gids, <span class="keyword">int</span> debugFlags,</span></span></div><div class="line">            <span class="keyword">int</span>[][] rlimits, <span class="keyword">long</span> permittedCapabilities, <span class="keyword">long</span> effectiveCapabilities);</div></pre></td></tr></table></figure>
<p>调用了native方法nativeForkSystemServe，这个方位定义在<code>com_android_internal_os_Zygote.cpp</code>中</p>
<p><code>/frameworks/base/core/jni/com_android_internal_os_Zygote.cpp：</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> jint <span class="title">com_android_internal_os_Zygote_nativeForkSystemServer</span><span class="params">(</span></span></div><div class="line">        JNIEnv* env, jclass, <span class="keyword">uid_t</span> uid, <span class="keyword">gid_t</span> gid, jintArray gids,</div><div class="line">        jint debug_flags, jobjectArray rlimits, jlong permittedCapabilities,</div><div class="line">        jlong effectiveCapabilities) &#123;</div><div class="line">  <span class="keyword">pid_t</span> pid = ForkAndSpecializeCommon(env, uid, gid, gids,</div><div class="line">                                      debug_flags, rlimits,</div><div class="line">                                      permittedCapabilities, effectiveCapabilities,</div><div class="line">                                      MOUNT_EXTERNAL_DEFAULT, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">true</span>, <span class="literal">NULL</span>,</div><div class="line">                                      <span class="literal">NULL</span>, <span class="literal">NULL</span>);</div><div class="line">  <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</div><div class="line">      gSystemServerPid = pid;</div><div class="line">      <span class="keyword">if</span> (waitpid(pid, &amp;status, WNOHANG) == pid) &#123;</div><div class="line">          RuntimeAbort(env, __LINE__, <span class="string">"System server process has died. Restarting Zygote!"</span>);</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> pid;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> pid_t <span class="title">ForkAndSpecializeCommon</span><span class="params">(JNIEnv* env, <span class="keyword">uid_t</span> uid, <span class="keyword">gid_t</span> gid, jintArray javaGids,</span></span></div><div class="line">                                     jint debug_flags, jobjectArray javaRlimits,</div><div class="line">                                     jlong permittedCapabilities, jlong effectiveCapabilities,</div><div class="line">                                     jint mount_external,</div><div class="line">                                     jstring java_se_info, jstring java_se_name,</div><div class="line">                                     <span class="keyword">bool</span> is_system_server, jintArray fdsToClose,</div><div class="line">                                     jstring instructionSet, jstring dataDir) &#123;</div><div class="line">  <span class="keyword">pid_t</span> pid = fork();</div><div class="line">  <span class="keyword">return</span> pid;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="system-server进程的执行"><a href="#system-server进程的执行" class="headerlink" title="system_server进程的执行"></a>system_server进程的执行</h1><p>上面fork了一个进程后，返回了pid,在回到ZygoteInit的startSystemServer方法：</p>
<p><code>/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java:</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startSystemServer</span><span class="params">(String abiList, String socketName)</span></span></div><div class="line">            <span class="keyword">throws</span> MethodAndArgsCaller, RuntimeException &#123;</div><div class="line">        <span class="comment">/* 硬编码命令行启动系统服务器 */</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//把上面的命令转为Arguments对象</span></div><div class="line">            parsedArgs = <span class="keyword">new</span> ZygoteConnection.Arguments(args);</div><div class="line">            <span class="comment">/* 从Zygote进程中fork一个system server 子进程 */</span></div><div class="line">            pid = Zygote.forkSystemServer(</div><div class="line">                    );</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</div><div class="line">            handleSystemServerProcess(parsedArgs);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>通过Zygote.forkSystemServer方法之后，system_server进程就产生了。下面就该这个进程干活了。</p>
<p>system_server进程生成后，执行了handleSystemServerProcess(parsedArgs)方法：</p>
<p><code>/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java:</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleSystemServerProcess</span><span class="params">(</span></span></div><div class="line">            ZygoteConnection.Arguments parsedArgs)</div><div class="line">            <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;</div><div class="line">        <span class="keyword">if</span> (parsedArgs.invokeWith != <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ClassLoader cl = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">if</span> (systemServerClasspath != <span class="keyword">null</span>) &#123;</div><div class="line">                cl = createSystemServerClassLoader(systemServerClasspath,parsedArgs.targetSdkVersion);</div><div class="line">                Thread.currentThread().setContextClassLoader(cl);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">/* 将参数传递给SystemServer. */</span></div><div class="line">            RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>下面是RuntimeInit.zygoteInit：</p>
<p><code>/frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">zygoteInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span></div><div class="line">            <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;</div><div class="line">        <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"RuntimeInit: Starting application from zygote"</span>);</div><div class="line">        commonInit();</div><div class="line">        nativeZygoteInit();</div><div class="line">        applicationInit(targetSdkVersion, argv, classLoader);</div><div class="line">    &#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">applicationInit</span><span class="params">(<span class="keyword">int</span> targetSdkVersion, String[] argv, ClassLoader classLoader)</span></span></div><div class="line">            <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;</div><div class="line">        nativeSetExitWithoutCleanup(<span class="keyword">true</span>);</div><div class="line">        <span class="comment">// 将参数传递给类的主方法 main()，也就是com.android.server.SystemServer的main方法。</span></div><div class="line">        invokeStaticMain(args.startClass, args.startArgs, classLoader);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeStaticMain</span><span class="params">(String className, String[] argv, ClassLoader classLoader)</span></span></div><div class="line">            <span class="keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;</div><div class="line">        Class&lt;?&gt; cl;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            cl = Class.forName(className, <span class="keyword">true</span>, classLoader);</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                    <span class="string">"Missing class when invoking static main "</span> + className,ex);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Method m;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//找到main方法</span></div><div class="line">            m = cl.getMethod(<span class="string">"main"</span>, <span class="keyword">new</span> Class[] &#123; String[].class &#125;);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                    <span class="string">"Missing static main on "</span> + className, ex);</div><div class="line">        &#125; <span class="keyword">catch</span> (SecurityException ex) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                    <span class="string">"Problem getting static main on "</span> + className, ex);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> modifiers = m.getModifiers();</div><div class="line">        <span class="keyword">if</span> (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</div><div class="line">                    <span class="string">"Main method is not public and static on "</span> + className);</div><div class="line">        &#125;</div><div class="line">         <span class="comment">//然后并没哟着这里执行，而是抛出了异常。</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ZygoteInit.MethodAndArgsCaller(m, argv);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>上面说是执行main方法，但是真正功能只是找到了main方法，然后并没有执行，而是抛出了一个异常ZygoteInit.MethodAndArgsCaller。这是ZygoteInit内部定义的一个异常。</p>
<p><code>/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java:</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodAndArgsCaller</span> <span class="keyword">extends</span> <span class="title">Exception</span></span></div><div class="line">            <span class="keyword">implements</span> <span class="title">Runnable</span> &#123;</div><div class="line">        <span class="comment">/** method to call */</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Method mMethod;</div><div class="line">        <span class="comment">/** argument array */</span></div><div class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String[] mArgs;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MethodAndArgsCaller</span><span class="params">(Method method, String[] args)</span> </span>&#123;</div><div class="line">            mMethod = method;</div><div class="line">            mArgs = args;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                mMethod.invoke(<span class="keyword">null</span>, <span class="keyword">new</span> Object[] &#123; mArgs &#125;);</div><div class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</div><div class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</div><div class="line">                Throwable cause = ex.getCause();</div><div class="line">                <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</div><div class="line">                    <span class="keyword">throw</span> (RuntimeException) cause;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Error) &#123;</div><div class="line">                    <span class="keyword">throw</span> (Error) cause;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(ex);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这个异常会一直向上抛，一直到ZygoteInit的main方法里才会捕捉处理：</p>
<p><code>/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java:</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String argv[])</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> (startSystemServer) &#123;</div><div class="line">                startSystemServer(abiList, socketName);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (MethodAndArgsCaller caller) &#123;</div><div class="line">            caller.run();</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">            Log.e(TAG, <span class="string">"Zygote died with exception"</span>, ex);</div><div class="line">            closeServerSocket();</div><div class="line">            <span class="keyword">throw</span> ex;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>看到上面的caller.run()，结合上面的MethodAndArgsCaller，这里才是真正执行SystemServer.main()方法的地方。</p>
<h1 id="SystemServer-main"><a href="#SystemServer-main" class="headerlink" title="SystemServer.main()"></a>SystemServer.main()</h1><p>这下终于进入SystemServer了</p>
<p>直接看进入的main方法,就一句：</p>
<p><code>/frameworks/base/services/java/com/android/server/SystemServer.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SNAPSHOT_INTERVAL = <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>; <span class="comment">// 1hr</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">new</span> SystemServer().run();</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">SystemServer</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Check for factory test mode.</span></div><div class="line">        mFactoryTestMode = FactoryTest.getMode();</div><div class="line">    &#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 调整系统时间</span></div><div class="line">            <span class="keyword">if</span> (System.currentTimeMillis() &lt; EARLIEST_SUPPORTED_TIME) &#123;</div><div class="line">                Slog.w(TAG, <span class="string">"System clock is before 1970; setting to 1970."</span>);</div><div class="line">                SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">//这里系统已经欢迎我们来到Android system server了。！。</span></div><div class="line">            <span class="comment">// Here we go!</span></div><div class="line">            Slog.i(TAG, <span class="string">"Entered the Android system server!"</span>);</div><div class="line">            EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_SYSTEM_RUN, SystemClock.uptimeMillis());</div><div class="line"></div><div class="line">            <span class="comment">// 性能采样分析，输出到文件.一小时执行一次</span></div><div class="line">            <span class="keyword">if</span> (SamplingProfilerIntegration.isEnabled()) &#123;</div><div class="line">                SamplingProfilerIntegration.start();</div><div class="line">                mProfilerSnapshotTimer = <span class="keyword">new</span> Timer();</div><div class="line">                mProfilerSnapshotTimer.schedule(<span class="keyword">new</span> TimerTask() &#123;</div><div class="line">                        <span class="meta">@Override</span></div><div class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                            SamplingProfilerIntegration.writeSnapshot(<span class="string">"system_server"</span>, <span class="keyword">null</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;, SNAPSHOT_INTERVAL, SNAPSHOT_INTERVAL);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//这里开启了一个Looper</span></div><div class="line">            android.os.Process.setThreadPriority(</div><div class="line">                android.os.Process.THREAD_PRIORITY_FOREGROUND);</div><div class="line">            android.os.Process.setCanSelfBackground(<span class="keyword">false</span>);</div><div class="line">            Looper.prepareMainLooper();</div><div class="line">            System.loadLibrary(<span class="string">"android_servers"</span>);</div><div class="line">            performPendingShutdown();</div><div class="line">            <span class="comment">//初始化系统Context</span></div><div class="line">            createSystemContext();</div><div class="line">            <span class="comment">// 创建SystemServiceManager</span></div><div class="line">            mSystemServiceManager = <span class="keyword">new</span> SystemServiceManager(mSystemContext);</div><div class="line">            LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 启动一些系统服务.</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            startBootstrapServices();</div><div class="line">            startCoreServices();</div><div class="line">            startOtherServices();</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</div><div class="line">            Slog.e(<span class="string">"System"</span>, <span class="string">"******************************************"</span>);</div><div class="line">            Slog.e(<span class="string">"System"</span>, <span class="string">"************ Failure starting system services"</span>, ex);</div><div class="line">            <span class="keyword">throw</span> ex;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</div><div class="line">        &#125;</div><div class="line">        Looper.loop();</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</div><div class="line">    &#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createSystemContext</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">//创建系统的Context是在ActivityThread中完成的。</span></div><div class="line">        ActivityThread activityThread = ActivityThread.systemMain();</div><div class="line">        mSystemContext = activityThread.getSystemContext();</div><div class="line">        mSystemContext.setTheme(DEFAULT_SYSTEM_THEME);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/Android/">Android</a><a href="/tags/源码/">源码</a></div><div class="post-share"></div><div class="post-nav"><a href="/2017/04/27/View动画执行过程和插值器作用/" class="pre">View动画执行过程和插值器作用</a><a href="/2017/04/25/AndroidStudio-JNI-CMake/" class="next">AndroidStudio JNI CMake</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">Contents</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#概括"><span class="toc-text">概括</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#init进程"><span class="toc-text">init进程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#zygote进程"><span class="toc-text">zygote进程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#进入Java代码-ZygoteInit-java"><span class="toc-text">进入Java代码 ZygoteInit.java</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#system-server进程的产生"><span class="toc-text">system_server进程的产生</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#system-server进程的执行"><span class="toc-text">system_server进程的执行</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SystemServer-main"><span class="toc-text">SystemServer.main()</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> Recent</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/08/15/APP启动页背景颜色变化/">APP启动页背景颜色变化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/31/ArrayList和LinkedList的简单实现/">ArrayList和LinkedList的简单实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/20/Android-socket的基本使用，发送文字和图片以及心跳/">Android-socket的基本使用，发送文字和图片以及心跳</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/11/将带有jni的Eclipse项目导入AndroidStudio遇到的问题/">将带有jni的Eclipse项目导入AndroidStudio遇到的问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/07/AVL树的旋转图解和简单实现/">AVL树的旋转图解和简单实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/07/查找二叉树的简单实现/">查找二叉树的简单实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/27/ADB常用命令/">ADB常用命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/23/Android解压中文乱码/">Android解压中文乱码</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/23/通过轮廓简单实现一个圆图/">通过轮廓简单实现一个圆图</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/15/Kotlin让属性只能被赋值一次且不能为空/">Kotlin让属性只能被赋值一次且不能为空</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> Tags</i></div><div class="tagcloud"><a href="/tags/多线程/" style="font-size: 15px;">多线程</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/数据结构/" style="font-size: 15px;">数据结构</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/工具/" style="font-size: 15px;">工具</a> <a href="/tags/文字识别/" style="font-size: 15px;">文字识别</a> <a href="/tags/动画/" style="font-size: 15px;">动画</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/版本控制/" style="font-size: 15px;">版本控制</a> <a href="/tags/Kotlin/" style="font-size: 15px;">Kotlin</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a> <a href="/tags/翻墙/" style="font-size: 15px;">翻墙</a> <a href="/tags/读书/" style="font-size: 15px;">读书</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> Archive</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> Blogroll</i></div><ul></ul><a href="http://blog.csdn.net/qq_25806863" title="csdn" target="_blank">csdn</a><ul></ul><a href="https://github.com/wangyisll" title="github" target="_blank">github</a><ul></ul><a href="http://www.jianshu.com/u/cb3133f5a1bd" title="简书" target="_blank">简书</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Sitemap</a> |  <a href="/atom.xml">RSS</a> |  <a href="/about/">About</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">喵了个呜.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script></body></html>